<!DOCTYPE html>
<html lang="PT-BR">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="shortcut icon" href="../assets/icon" type="image/x-icon" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;400;700&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="styleprincipal.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="alerta.js"></script>
  <title>Dashboard</title>
</head>

<body onload="mudarkpi()">
  <div class="dashHeader">
    <div class="dashNav">
      <div class="dashNavOpts">
        <a href="../index.html">
          <ion-icon name="home-outline"></ion-icon>
        </a>

        <a href="../Simulador Financeiro/simulador.html">
          <ion-icon name="cube-outline"></ion-icon>
        </a>
      </div>


      <div class="dashNavOptsdown">

        <div class="areabotaomododark" onclick="darkmode()">
          <ion-icon class="iconmodelight" name="sunny-outline"></ion-icon>
          <ion-icon class="iconmodedark" name="moon-outline"></ion-icon>
          <div id="botaomudarmode"></div>
        </div>

        <ion-icon name="person-circle-outline"></ion-icon>

      </div>
    </div>
  </div>

  <div class="dashSensor">
    <div class="dashSensorNav">
      <div class="dashSensorNavOpts">
        <a href="temperatura.html">

          <ion-icon name="thermometer-outline"></ion-icon>
          <img id="temperatura" src="assets/-GIF-Loading-Red-Spot-1--unscreen.gif" alt="">

        </a>
      </div>
      <div class="dashSensorNavOpts">
        <ion-icon name="analytics-outline"></ion-icon>
      </div>
      <div class="dashSensorNavOpts">
        <a href="umidade.html">
          <ion-icon name="water-outline"></ion-icon>
          <img id="umidade" src="assets/-GIF-Loading-Red-Spot-1--unscreen.gif" alt="">
        </a>
      </div>
    </div>
  </div>

  <div class="box3">
    <div class="one">
      <div class="dashGraphSensorOne">
        <div class="corpoKpi">

          <div class="kpi">

            <div class="kpiRed">
              <p id="tituloP1">Muito baixa</p>
              <p id="p1">18.0°C</p>
            </div>

            <div class="kpiYellow">
              <p>Zona de risco</p>
              <p id="p2">19.5°C</p>
            </div>

            <div class="kpiGreen">
              <p>Ideal</p>
              <p id="p3">22.5°C</p>
            </div>

            <div class="kpiYellow">
              <p>Zona de risco</p>
              <p id="p4">25.5°C</p>
            </div>

            <div class="kpiRed">
              <p>Muito alta</p>
              <p id="p5">27.0°C</p>
            </div>
          </div>
        </div>

        <div class="grafico">
          <div class="tm">
            <h2>Registros do último intervalo (15min)</h2>
            <canvas id="myChart5"></canvas>
            <!-- grafico  -->
          </div>
        </div>

        <div class="dashSensorsInfo1">
          <div class="blockGraph">
            <div class="parametry">
              <h2>Temperatura</h2>
              <p class="temperatura">
                Mínima:
                <ion-icon name="thermometer-outline"></ion-icon> 17.1°C <br />
                Máxima:
                <ion-icon name="thermometer-outline"></ion-icon> 22.7°C
              </p>
            </div>

            <div class="parametry D">
              <h2>Umidade</h2>
              <p class="umidade">
                Mínima: <ion-icon name="water-outline"></ion-icon> 46.8%
                <br />
                Máxima: <ion-icon name="water-outline"></ion-icon> 49.8%
              </p>
            </div>
          </div>

          <div class="blockdown">
            <div class="contsTemp" id="contsTemp">
              <p id="tTempreal">Sensor 1</p>
              <p id="tempreal">18.6°C</p>
            </div>
            <div class="contsUmid">
              <p id="tUmidreal">Sensor 1</p>
              <p id="umidReal">47.2%</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>

<script src="kpi.js"></script>

<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<script src="graficoPrin.js"></script>



<script>

  window.onload = obterDadosGrafico(1);

  function darkmode() {
    if (sessionStorage.MODE_COLOR == 'light') {

      document.querySelector('.areabotaomododark').style.backgroundColor = 'rgb(0 0 0 / 94%)';
      document.querySelector('.areabotaomododark').style.justifyContent = "flex-end";
      document.querySelector('body').style.backgroundColor = 'rgb(0 0 0 / 94%)';
      document.querySelector('.tm h2').style.color = 'white';
      sessionStorage.MODE_COLOR = 'dark';
    } else {
      document.querySelector('.areabotaomododark').style.backgroundColor = 'rgb(230, 230, 230)';
      document.querySelector('.areabotaomododark').style.justifyContent = "flex-start";
      document.querySelector('body').style.backgroundColor = 'rgb(230, 230, 230)';
      document.querySelector('.tm h2').style.color = 'black';

      sessionStorage.MODE_COLOR = 'light'
    }
  }

  if (sessionStorage.MODE_COLOR == 'dark') {
    document.querySelector('.areabotaomododark').style.backgroundColor = 'rgb(0 0 0 / 94%)';
    document.querySelector('.areabotaomododark').style.justifyContent = "flex-end";
    document.querySelector('body').style.backgroundColor = 'rgb(0 0 0 / 94%)';
    document.querySelector('.tm h2').style.color = 'white';
    sessionStorage.MODE_COLOR = 'dark';
  } else {
    document.querySelector('.areabotaomododark').style.backgroundColor = 'rgb(230, 230, 230)';
    document.querySelector('.areabotaomododark').style.justifyContent = "flex-start";
    document.querySelector('body').style.backgroundColor = 'rgb(230, 230, 230)';
    document.querySelector('.tm h2').style.color = 'black';
    sessionStorage.MODE_COLOR == 'light'
  }


  function obterDadosGrafico() {
    // alterarTitulo(idSensor)

    // if (proximaAtualizacao != undefined) {
    //     clearTimeout(proximaAtualizacao);
    // }


    fetch(`/medidas/metricas`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
        response.json().then(function (resposta) {
          console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
          resposta.reverse();



          plotarGraficoBarras(resposta);
        });
      } else {
        console.error('Nenhum dado encontrado ou erro na API');
      }
    })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });

  }

  // function removeDuplicates(arr) {
  //       return arr.filter((item,
  //           index) => arr.indexOf(item) === index);
  //   }

  function plotarGraficoBarras(resposta) {
    // Criando estrutura para plotar gráfico - labels


    var labels2 = [];


    var dados2 = {
      labels: labels2,
      datasets: [{
        label: 'Umidade',
        fill: false,
        data: [],
        backgroundColor: 'rgba(0, 157, 255, 0.99)',
        borderColor: 'rgba(0, 157, 255, 0.99)'

      },
      {
        label: 'Temperatura',
        fill: false,
        data: [],
        backgroundColor: ' rgba(255, 128, 0, 0.99)',
        borderColor: ' rgba(255, 128, 0, 0.99)'
      }]
    }
    // Inserindo valores recebidos em estrutura para plotar o gráfico

    for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      console.log('DENTRO DO FOR DE PLOTAR')

        

      dados2.datasets[0].data.push(registro.umidadeAtual)
      dados2.datasets[1].data.push(registro.temperaturaAtual)
      labels2.push(registro.idSensor);

    }

    // dados2.labels = removeDuplicates(labels2);

    // Criando estrutura para plotar gráfico - config
    const config = {
      type: 'bar',
      data: dados2,
      options: {
        scales: {
          y: {

            borderColor: 'rgba(0, 157, 255, 0.99)',
            // showLine: true,

          }
        }
      }
    };

    var myChart5 = new Chart(
      document.getElementById('myChart5'),
      config
    );








  };








    // function atualizarGrafico(idSensor, dados, myChart2) {

    //     fetch(`/medidas/tempo-real/${idSensor}`, { cache: 'no-store' }).then(function (response) {
    //         if (response.ok) {
    //             response.json().then(function (novoRegistro) {

    //                 console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
    //                 console.log(`Dados atuais do gráfico:`);
    //                 console.log(dados);

    //                 document.getElementById("avisoCaptura").innerHTML = ""

    //                 if (novoRegistro[0].dtHora == dados.labels[dados.labels.length - 1]) {
    //                     console.log("---------------------------------------------------------------")
    //                     console.log("Como não há dados novos para captura, o gráfico não atualizará.")
    //                     document.getElementById("avisoCaptura").innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
    //                     console.log("Horário do novo dado capturado:")
    //                     console.log(novoRegistro[0].dtHora)
    //                     console.log("Horário do último dado capturado:")
    //                     console.log(dados.labels[dados.labels.length - 1])
    //                     console.log("---------------------------------------------------------------")
    //                 } else {
    //                     // tirando e colocando valores no gráfico
    //                     dados.labels.shift(); // apagar o primeiro
    //                     dados.labels.push(novoRegistro[0].dtHora); // incluir um novo momento

    //                     dados.datasets[0].data.shift();  // apagar o primeiro de umidade
    //                     dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

    //                     dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
    //                     dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

    //                     myChart2.update();
    //                 }

    //                 // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
    //                 proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados, myChart2), 2000);
    //             });
    //         } else {
    //             console.error('Nenhum dado encontrado ou erro na API');
    //             // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
    //             proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados, myChart2), 2000);
    //         }
    //     })
    //         .catch(function (error) {
    //             console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    //         });

    // }


</script>