<!DOCTYPE html>
<html lang="PT-BR">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../assets/icon" type="image/x-icon">

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="styleprincipal.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Dashboard</title>
</head>

<body>

    <div class="dashHeader">
        <div class="dashNav">
            <div class="dashNavOpts">
                <a href="../index.html">
                    <ion-icon name="home-outline"></ion-icon>
                </a>

                <a href="../Simulador Financeiro/simulador.html">
                    <ion-icon name="cube-outline"></ion-icon>
                </a>
            </div>
            <div class="dashNavOptsdown">

                <div class="areabotaomododark" onclick="darkmode()">
                  <div id="botaomudarmode"></div>
                </div>
        
                <ion-icon name="person-circle-outline"></ion-icon>
        
              </div>
        </div>
    </div>

    <div class="dashSensor">

        <div class="dashSensors" onclick="abrir()">
            <div class="dashSensorsOpts">
                <ion-icon name="apps-outline"></ion-icon>
            </div>
        </div>

        <div class="dashSensorNav">

            <!-- Opt Temperatura -->
            <div class="dashSensorNavOpts">
                <a href="temperatura.html">
                    <ion-icon name="thermometer-outline"></ion-icon>
                </a>
            </div>

            <!-- Opt Analytics -->
            <div class="dashSensorNavOpts">
                <a href="dashprincipal.html">
                    <ion-icon name="analytics-outline"></ion-icon>
                </a>
            </div>

            <!-- Opt Umidade -->
            <div class="dashSensorNavOpts">
                <ion-icon name="water-outline"></ion-icon>
            </div>

        </div>

    </div>

    <div class="dashGraphs">
        <div class="dashSensorOne">
            <div class="dashGraphSensorOne">
                <h2>Gráfico de Umidade - Sensor 1</h2>
                <canvas id="myChart1"></canvas>
            </div>
            <div class="dashSensorsInfo">
                <h2>Umidade</h2>
                <p class="umidade">
                    <ion-icon name="water-outline"></ion-icon>Max: 24.1%
                </p>
                <p class="umidade">
                    <ion-icon name="water-outline"></ion-icon>Min: 18.1%
                </p>
                <div class="dashSensorsCurrentInfo">
                    <h3>Sensor 1</h3>
                    <p class="umidade">18.1 ºC</p>
                </div>
            </div>
        </div>
    </div>

</body>

</html>

<!-- <script src="graficosUmid.js"></script> -->
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

<script src="kpi.js"></script>
<script src="dark.js"></script>



<script>

    // b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    //     let proximaAtualizacao;

    window.onload = obterDadosGrafico(1);

    // verificar_autenticacao();

    // function alterarTitulo(idSensor) {
    //     var tituloAquario = document.getElementById("tituloAquario")
    //     tituloAquario.innerHTML = "Últimas medidas de Temperatura e Umidade do <span style='color: #e6005a'>Aquário " + idSensor + "</span>"
    // }

    function obterDadosGrafico(idSensor) {
        // alterarTitulo(idSensor)

        // if (proximaAtualizacao != undefined) {
        //     clearTimeout(proximaAtualizacao);
        // }

        fetch(`/medidas/umidade/1`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    // resposta.reverse();


                    plotarGrafico(resposta, idSensor);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }


    function plotarGrafico(resposta, idSensor) {
        // Criando estrutura para plotar gráfico - labels

        var labels = [];

        // Criando estrutura para plotar gráfico - dados
        var dados = {
            labels: labels,
            datasets: [{
                label: 'Umidade',
                data: [],
                fill: false,
                borderColor: 'rgb(92, 51, 23)',
                backgroundColor: 'rgb(92, 51, 23)',
                tension: 0.1

            }]
        };

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            // console.log("registros que vieram")
            // console.log(registro)
            labels.push(registro.hora);
            dados.datasets[0].data.push(registro.umidadeAtual); // VERIFICAR
        }


        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
            options: {
                scales: {
                    y: {

                        borderColor: 'rgb(92, 51, 23)',
                        // showLine: true,

                    }
                }
            }
        };

        var myChart1 = new Chart(
            document.getElementById('myChart1'),
            config
        );
    }




    // function atualizarGrafico(idSensor, dados, myChart) {

    //     fetch(`/medidas/tempo-real/${idSensor}`, { cache: 'no-store' }).then(function (response) {
    //         if (response.ok) {
    //             response.json().then(function (novoRegistro) {

    //                 console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
    //                 console.log(`Dados atuais do gráfico:`);
    //                 console.log(dados);

    //                 document.getElementById("avisoCaptura").innerHTML = ""

    //                 if (novoRegistro[0].dtHora == dados.labels[dados.labels.length - 1]) {
    //                     console.log("---------------------------------------------------------------")
    //                     console.log("Como não há dados novos para captura, o gráfico não atualizará.")
    //                     document.getElementById("avisoCaptura").innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
    //                     console.log("Horário do novo dado capturado:")
    //                     console.log(novoRegistro[0].dtHora)
    //                     console.log("Horário do último dado capturado:")
    //                     console.log(dados.labels[dados.labels.length - 1])
    //                     console.log("---------------------------------------------------------------")
    //                 } else {
    //                     // tirando e colocando valores no gráfico
    //                     dados.labels.shift(); // apagar o primeiro
    //                     dados.labels.push(novoRegistro[0].dtHora); // incluir um novo momento

    //                     dados.datasets[0].data.shift();  // apagar o primeiro de umidade
    //                     dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

    //                     dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
    //                     dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

    //                     myChart.update();
    //                 }

    //                 // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
    //                 proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados, myChart), 2000);
    //             });
    //         } else {
    //             console.error('Nenhum dado encontrado ou erro na API');
    //             // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
    //             proximaAtualizacao = setTimeout(() => atualizarGrafico(idSensor, dados, myChart), 2000);
    //         }
    //     })
    //         .catch(function (error) {
    //             console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    //         });

    // }



    function darkmode() {
    if (sessionStorage.MODE_COLOR == 'light') {

      document.querySelector('.areabotaomododark').style.justifyContent = "flex-end";
      document.querySelector('body').style.backgroundColor = 'rgb(0 0 0 / 94%)';
      sessionStorage.MODE_COLOR = 'dark';
    } else {
      document.querySelector('.areabotaomododark').style.justifyContent = "flex-start";
      document.querySelector('body').style.backgroundColor = 'rgb(230, 230, 230)';
      sessionStorage.MODE_COLOR = 'light'
    }
  }


    if (sessionStorage.MODE_COLOR == 'dark') {
        document.querySelector('.areabotaomododark').style.justifyContent = "flex-end";
        document.querySelector('body').style.backgroundColor = 'rgb(0 0 0 / 94%)';
        sessionStorage.MODE_COLOR = 'dark';
    } else {
        document.querySelector('.areabotaomododark').style.justifyContent = "flex-start";
        document.querySelector('body').style.backgroundColor = 'rgb(230, 230, 230)';
        sessionStorage.MODE_COLOR == 'light'
    }




</script>